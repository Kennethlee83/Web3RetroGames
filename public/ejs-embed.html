<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EmulatorJS Embed</title>
  <style>
    html, body { height: 100%; margin: 0; background: #000; }
    #game { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="game"></div>
  <script>
    // Read ROM URL from hash
    (function() {
      try {
        var hash = (location.hash || '').slice(1);
        var params = new URLSearchParams(hash);
        var romUrl = params.get('rom') ? decodeURIComponent(params.get('rom')) : decodeURIComponent(hash || '');
        var coreFromHash = params.get('core') ? params.get('core') : null;
        // Basic config
        window.EJS_player = '#game';
        window.EJS_gameUrl = romUrl;
        window.EJS_core = coreFromHash || 'snes9x';
        window.EJS_pathtodata = '/emulatorjs/data/';
        window.EJS_startOnLoaded = true;
        window.EJS_volume = 0.5;
        window.EJS_mute = false;
        window.EJS_multitap = true;
        window.EJS_playerCount = 2;
        // Force fresh defaults (ignore any saved control mappings)
        window.EJS_disableLocalStorage = true;
        window.EJS_disableDatabases = true;
        
        console.log('ðŸŽ® EmulatorJS configured with ROM:', romUrl);
      } catch (e) {
        console.error('Failed to parse ROM URL:', e);
      }
    })();
    
    // Notify parent when the emulator canvas becomes available
    (function waitForCanvas(){
      try {
        var found = document.querySelector('canvas');
        if (found) {
          try { parent && parent.postMessage({ type:'ejs-canvas-ready' }, '*'); } catch(_) {}
        } else {
          setTimeout(waitForCanvas, 300);
        }
      } catch(_) { setTimeout(waitForCanvas, 300); }
    })();
    
    // Handle Player 2 input messages from parent
    window.addEventListener('message', function(event) {
      if (event.data && event.data.type === 'player2_input') {
        handlePlayer2Input(event.data.control, event.data.pressed);
      }
    });
    
    // Handle Player 2 input
    function handlePlayer2Input(control, pressed) {
      console.log('ðŸŽ® EJS: Player 2 input:', control, pressed);
      
      // Map controls to keyboard events
      const keyMap = {
        'up': 'ArrowUp',
        'down': 'ArrowDown', 
        'left': 'ArrowLeft',
        'right': 'ArrowRight',
        'a': 'KeyZ',
        'b': 'KeyX',
        'start': 'Enter',
        'select': 'Space'
      };
      
      const key = keyMap[control];
      if (key) {
        const event = new KeyboardEvent(pressed ? 'keydown' : 'keyup', {
          code: key,
          key: key,
          bubbles: true
        });
        
        // Dispatch to document to trigger EmulatorJS input handlers
        document.dispatchEvent(event);
        console.log('ðŸŽ® EJS: Dispatched', pressed ? 'keydown' : 'keyup', 'for', key);
      }
    }
  </script>
  <script src="/emulatorjs/data/loader.js"></script>
</body>
</html>